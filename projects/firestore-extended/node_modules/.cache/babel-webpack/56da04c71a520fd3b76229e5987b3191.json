{"ast":null,"code":"import { __awaiter, __generator, __assign } from 'tslib';\nimport firebase from '@firebase/app';\nimport '@firebase/installations';\nimport { Logger } from '@firebase/logger';\nimport { ErrorFactory, calculateBackoffMillis, FirebaseError, validateIndexedDBOpenable, isIndexedDBAvailable, isBrowserExtension, areCookiesEnabled } from '@firebase/util';\nimport { Component } from '@firebase/component';\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n// Key to attach FID to in gtag params.\n\nvar GA_FID_KEY = 'firebase_id';\nvar ORIGIN_KEY = 'origin';\nvar FETCH_TIMEOUT_MILLIS = 60 * 1000;\nvar DYNAMIC_CONFIG_URL = 'https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig';\nvar GTAG_URL = 'https://www.googletagmanager.com/gtag/js';\nvar GtagCommand;\n\n(function (GtagCommand) {\n  GtagCommand[\"EVENT\"] = \"event\";\n  GtagCommand[\"SET\"] = \"set\";\n  GtagCommand[\"CONFIG\"] = \"config\";\n})(GtagCommand || (GtagCommand = {}));\n/**\r\n * Officially recommended event names for gtag.js\r\n * Any other string is also allowed.\r\n *\r\n * @public\r\n */\n\n\nvar EventName;\n\n(function (EventName) {\n  EventName[\"ADD_SHIPPING_INFO\"] = \"add_shipping_info\";\n  EventName[\"ADD_PAYMENT_INFO\"] = \"add_payment_info\";\n  EventName[\"ADD_TO_CART\"] = \"add_to_cart\";\n  EventName[\"ADD_TO_WISHLIST\"] = \"add_to_wishlist\";\n  EventName[\"BEGIN_CHECKOUT\"] = \"begin_checkout\";\n  /**\r\n   * @deprecated\r\n   * This event name is deprecated and is unsupported in updated\r\n   * Enhanced Ecommerce reports.\r\n   */\n\n  EventName[\"CHECKOUT_PROGRESS\"] = \"checkout_progress\";\n  EventName[\"EXCEPTION\"] = \"exception\";\n  EventName[\"GENERATE_LEAD\"] = \"generate_lead\";\n  EventName[\"LOGIN\"] = \"login\";\n  EventName[\"PAGE_VIEW\"] = \"page_view\";\n  EventName[\"PURCHASE\"] = \"purchase\";\n  EventName[\"REFUND\"] = \"refund\";\n  EventName[\"REMOVE_FROM_CART\"] = \"remove_from_cart\";\n  EventName[\"SCREEN_VIEW\"] = \"screen_view\";\n  EventName[\"SEARCH\"] = \"search\";\n  EventName[\"SELECT_CONTENT\"] = \"select_content\";\n  EventName[\"SELECT_ITEM\"] = \"select_item\";\n  EventName[\"SELECT_PROMOTION\"] = \"select_promotion\";\n  /** @deprecated */\n\n  EventName[\"SET_CHECKOUT_OPTION\"] = \"set_checkout_option\";\n  EventName[\"SHARE\"] = \"share\";\n  EventName[\"SIGN_UP\"] = \"sign_up\";\n  EventName[\"TIMING_COMPLETE\"] = \"timing_complete\";\n  EventName[\"VIEW_CART\"] = \"view_cart\";\n  EventName[\"VIEW_ITEM\"] = \"view_item\";\n  EventName[\"VIEW_ITEM_LIST\"] = \"view_item_list\";\n  EventName[\"VIEW_PROMOTION\"] = \"view_promotion\";\n  EventName[\"VIEW_SEARCH_RESULTS\"] = \"view_search_results\";\n})(EventName || (EventName = {}));\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n\n/**\r\n * Logs an analytics event through the Firebase SDK.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param eventName Google Analytics event name, choose from standard list or use a custom string.\r\n * @param eventParams Analytics event parameters.\r\n */\n\n\nfunction logEvent(gtagFunction, initializationPromise, eventName, eventParams, options) {\n  return __awaiter(this, void 0, void 0, function () {\n    var measurementId, params;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (!(options && options.global)) return [3\n          /*break*/\n          , 1];\n          gtagFunction(GtagCommand.EVENT, eventName, eventParams);\n          return [2\n          /*return*/\n          ];\n\n        case 1:\n          return [4\n          /*yield*/\n          , initializationPromise];\n\n        case 2:\n          measurementId = _a.sent();\n          params = __assign(__assign({}, eventParams), {\n            'send_to': measurementId\n          });\n          gtagFunction(GtagCommand.EVENT, eventName, params);\n          _a.label = 3;\n\n        case 3:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * Set screen_name parameter for this Google Analytics ID.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param screenName Screen name string to set.\r\n */\n\n\nfunction setCurrentScreen(gtagFunction, initializationPromise, screenName, options) {\n  return __awaiter(this, void 0, void 0, function () {\n    var measurementId;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (!(options && options.global)) return [3\n          /*break*/\n          , 1];\n          gtagFunction(GtagCommand.SET, {\n            'screen_name': screenName\n          });\n          return [2\n          /*return*/\n          , Promise.resolve()];\n\n        case 1:\n          return [4\n          /*yield*/\n          , initializationPromise];\n\n        case 2:\n          measurementId = _a.sent();\n          gtagFunction(GtagCommand.CONFIG, measurementId, {\n            update: true,\n            'screen_name': screenName\n          });\n          _a.label = 3;\n\n        case 3:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * Set user_id parameter for this Google Analytics ID.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param id User ID string to set\r\n */\n\n\nfunction setUserId(gtagFunction, initializationPromise, id, options) {\n  return __awaiter(this, void 0, void 0, function () {\n    var measurementId;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (!(options && options.global)) return [3\n          /*break*/\n          , 1];\n          gtagFunction(GtagCommand.SET, {\n            'user_id': id\n          });\n          return [2\n          /*return*/\n          , Promise.resolve()];\n\n        case 1:\n          return [4\n          /*yield*/\n          , initializationPromise];\n\n        case 2:\n          measurementId = _a.sent();\n          gtagFunction(GtagCommand.CONFIG, measurementId, {\n            update: true,\n            'user_id': id\n          });\n          _a.label = 3;\n\n        case 3:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * Set all other user properties other than user_id and screen_name.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param properties Map of user properties to set\r\n */\n\n\nfunction setUserProperties(gtagFunction, initializationPromise, properties, options) {\n  return __awaiter(this, void 0, void 0, function () {\n    var flatProperties, _i, _a, key, measurementId;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          if (!(options && options.global)) return [3\n          /*break*/\n          , 1];\n          flatProperties = {};\n\n          for (_i = 0, _a = Object.keys(properties); _i < _a.length; _i++) {\n            key = _a[_i]; // use dot notation for merge behavior in gtag.js\n\n            flatProperties[\"user_properties.\" + key] = properties[key];\n          }\n\n          gtagFunction(GtagCommand.SET, flatProperties);\n          return [2\n          /*return*/\n          , Promise.resolve()];\n\n        case 1:\n          return [4\n          /*yield*/\n          , initializationPromise];\n\n        case 2:\n          measurementId = _b.sent();\n          gtagFunction(GtagCommand.CONFIG, measurementId, {\n            update: true,\n            'user_properties': properties\n          });\n          _b.label = 3;\n\n        case 3:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * Set whether collection is enabled for this ID.\r\n *\r\n * @param enabled If true, collection is enabled for this ID.\r\n */\n\n\nfunction setAnalyticsCollectionEnabled(initializationPromise, enabled) {\n  return __awaiter(this, void 0, void 0, function () {\n    var measurementId;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , initializationPromise];\n\n        case 1:\n          measurementId = _a.sent();\n          window[\"ga-disable-\" + measurementId] = !enabled;\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n\n\nvar logger = new Logger('@firebase/analytics');\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n\n/**\r\n * Inserts gtag script tag into the page to asynchronously download gtag.\r\n * @param dataLayerName Name of datalayer (most often the default, \"_dataLayer\").\r\n */\n\nfunction insertScriptTag(dataLayerName, measurementId) {\n  var script = document.createElement('script');\n  script.src = GTAG_URL + \"?l=\" + dataLayerName + \"&id=\" + measurementId;\n  script.async = true;\n  document.head.appendChild(script);\n}\n/**\r\n * Get reference to, or create, global datalayer.\r\n * @param dataLayerName Name of datalayer (most often the default, \"_dataLayer\").\r\n */\n\n\nfunction getOrCreateDataLayer(dataLayerName) {\n  // Check for existing dataLayer and create if needed.\n  var dataLayer = [];\n\n  if (Array.isArray(window[dataLayerName])) {\n    dataLayer = window[dataLayerName];\n  } else {\n    window[dataLayerName] = dataLayer;\n  }\n\n  return dataLayer;\n}\n/**\r\n * Wrapped gtag logic when gtag is called with 'config' command.\r\n *\r\n * @param gtagCore Basic gtag function that just appends to dataLayer.\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementIdToAppId Map of GA measurementIDs to corresponding Firebase appId.\r\n * @param measurementId GA Measurement ID to set config for.\r\n * @param gtagParams Gtag config params to set.\r\n */\n\n\nfunction gtagOnConfig(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, measurementId, gtagParams) {\n  return __awaiter(this, void 0, void 0, function () {\n    var correspondingAppId, dynamicConfigResults, foundConfig, e_1;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          correspondingAppId = measurementIdToAppId[measurementId];\n          _a.label = 1;\n\n        case 1:\n          _a.trys.push([1, 7,, 8]);\n\n          if (!correspondingAppId) return [3\n          /*break*/\n          , 3];\n          return [4\n          /*yield*/\n          , initializationPromisesMap[correspondingAppId]];\n\n        case 2:\n          _a.sent();\n\n          return [3\n          /*break*/\n          , 6];\n\n        case 3:\n          return [4\n          /*yield*/\n          , Promise.all(dynamicConfigPromisesList)];\n\n        case 4:\n          dynamicConfigResults = _a.sent();\n          foundConfig = dynamicConfigResults.find(function (config) {\n            return config.measurementId === measurementId;\n          });\n          if (!foundConfig) return [3\n          /*break*/\n          , 6];\n          return [4\n          /*yield*/\n          , initializationPromisesMap[foundConfig.appId]];\n\n        case 5:\n          _a.sent();\n\n          _a.label = 6;\n\n        case 6:\n          return [3\n          /*break*/\n          , 8];\n\n        case 7:\n          e_1 = _a.sent();\n          logger.error(e_1);\n          return [3\n          /*break*/\n          , 8];\n\n        case 8:\n          gtagCore(GtagCommand.CONFIG, measurementId, gtagParams);\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * Wrapped gtag logic when gtag is called with 'event' command.\r\n *\r\n * @param gtagCore Basic gtag function that just appends to dataLayer.\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementId GA Measurement ID to log event to.\r\n * @param gtagParams Params to log with this event.\r\n */\n\n\nfunction gtagOnEvent(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementId, gtagParams) {\n  return __awaiter(this, void 0, void 0, function () {\n    var initializationPromisesToWaitFor, gaSendToList, dynamicConfigResults, _loop_1, _i, gaSendToList_1, sendToId, state_1, e_2;\n\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          _a.trys.push([0, 4,, 5]);\n\n          initializationPromisesToWaitFor = [];\n          if (!(gtagParams && gtagParams['send_to'])) return [3\n          /*break*/\n          , 2];\n          gaSendToList = gtagParams['send_to']; // Make it an array if is isn't, so it can be dealt with the same way.\n\n          if (!Array.isArray(gaSendToList)) {\n            gaSendToList = [gaSendToList];\n          }\n\n          return [4\n          /*yield*/\n          , Promise.all(dynamicConfigPromisesList)];\n\n        case 1:\n          dynamicConfigResults = _a.sent();\n\n          _loop_1 = function (sendToId) {\n            // Any fetched dynamic measurement ID that matches this 'send_to' ID\n            var foundConfig = dynamicConfigResults.find(function (config) {\n              return config.measurementId === sendToId;\n            });\n            var initializationPromise = foundConfig && initializationPromisesMap[foundConfig.appId];\n\n            if (initializationPromise) {\n              initializationPromisesToWaitFor.push(initializationPromise);\n            } else {\n              // Found an item in 'send_to' that is not associated\n              // directly with an FID, possibly a group.  Empty this array,\n              // exit the loop early, and let it get populated below.\n              initializationPromisesToWaitFor = [];\n              return \"break\";\n            }\n          };\n\n          for (_i = 0, gaSendToList_1 = gaSendToList; _i < gaSendToList_1.length; _i++) {\n            sendToId = gaSendToList_1[_i];\n            state_1 = _loop_1(sendToId);\n            if (state_1 === \"break\") break;\n          }\n\n          _a.label = 2;\n\n        case 2:\n          // This will be unpopulated if there was no 'send_to' field , or\n          // if not all entries in the 'send_to' field could be mapped to\n          // a FID. In these cases, wait on all pending initialization promises.\n          if (initializationPromisesToWaitFor.length === 0) {\n            initializationPromisesToWaitFor = Object.values(initializationPromisesMap);\n          } // Run core gtag function with args after all relevant initialization\n          // promises have been resolved.\n\n\n          return [4\n          /*yield*/\n          , Promise.all(initializationPromisesToWaitFor)];\n\n        case 3:\n          // Run core gtag function with args after all relevant initialization\n          // promises have been resolved.\n          _a.sent(); // Workaround for http://b/141370449 - third argument cannot be undefined.\n\n\n          gtagCore(GtagCommand.EVENT, measurementId, gtagParams || {});\n          return [3\n          /*break*/\n          , 5];\n\n        case 4:\n          e_2 = _a.sent();\n          logger.error(e_2);\n          return [3\n          /*break*/\n          , 5];\n\n        case 5:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * Wraps a standard gtag function with extra code to wait for completion of\r\n * relevant initialization promises before sending requests.\r\n *\r\n * @param gtagCore Basic gtag function that just appends to dataLayer.\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementIdToAppId Map of GA measurementIDs to corresponding Firebase appId.\r\n */\n\n\nfunction wrapGtag(gtagCore,\n/**\r\n * Allows wrapped gtag calls to wait on whichever intialization promises are required,\r\n * depending on the contents of the gtag params' `send_to` field, if any.\r\n */\ninitializationPromisesMap,\n/**\r\n * Wrapped gtag calls sometimes require all dynamic config fetches to have returned\r\n * before determining what initialization promises (which include FIDs) to wait for.\r\n */\ndynamicConfigPromisesList,\n/**\r\n * Wrapped gtag config calls can narrow down which initialization promise (with FID)\r\n * to wait for if the measurementId is already fetched, by getting the corresponding appId,\r\n * which is the key for the initialization promises map.\r\n */\nmeasurementIdToAppId) {\n  /**\r\n   * Wrapper around gtag that ensures FID is sent with gtag calls.\r\n   * @param command Gtag command type.\r\n   * @param idOrNameOrParams Measurement ID if command is EVENT/CONFIG, params if command is SET.\r\n   * @param gtagParams Params if event is EVENT/CONFIG.\r\n   */\n  function gtagWrapper(command, idOrNameOrParams, gtagParams) {\n    return __awaiter(this, void 0, void 0, function () {\n      var e_3;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 6,, 7]);\n\n            if (!(command === GtagCommand.EVENT)) return [3\n            /*break*/\n            , 2]; // If EVENT, second arg must be measurementId.\n\n            return [4\n            /*yield*/\n            , gtagOnEvent(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, idOrNameOrParams, gtagParams)];\n\n          case 1:\n            // If EVENT, second arg must be measurementId.\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 5];\n\n          case 2:\n            if (!(command === GtagCommand.CONFIG)) return [3\n            /*break*/\n            , 4]; // If CONFIG, second arg must be measurementId.\n\n            return [4\n            /*yield*/\n            , gtagOnConfig(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, idOrNameOrParams, gtagParams)];\n\n          case 3:\n            // If CONFIG, second arg must be measurementId.\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 5];\n\n          case 4:\n            // If SET, second arg must be params.\n            gtagCore(GtagCommand.SET, idOrNameOrParams);\n            _a.label = 5;\n\n          case 5:\n            return [3\n            /*break*/\n            , 7];\n\n          case 6:\n            e_3 = _a.sent();\n            logger.error(e_3);\n            return [3\n            /*break*/\n            , 7];\n\n          case 7:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  }\n\n  return gtagWrapper;\n}\n/**\r\n * Creates global gtag function or wraps existing one if found.\r\n * This wrapped function attaches Firebase instance ID (FID) to gtag 'config' and\r\n * 'event' calls that belong to the GAID associated with this Firebase instance.\r\n *\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementIdToAppId Map of GA measurementIDs to corresponding Firebase appId.\r\n * @param dataLayerName Name of global GA datalayer array.\r\n * @param gtagFunctionName Name of global gtag function (\"gtag\" if not user-specified).\r\n */\n\n\nfunction wrapOrCreateGtag(initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, dataLayerName, gtagFunctionName) {\n  // Create a basic core gtag function\n  var gtagCore = function () {\n    var _args = [];\n\n    for (var _i = 0; _i < arguments.length; _i++) {\n      _args[_i] = arguments[_i];\n    } // Must push IArguments object, not an array.\n\n\n    window[dataLayerName].push(arguments);\n  }; // Replace it with existing one if found\n\n\n  if (window[gtagFunctionName] && typeof window[gtagFunctionName] === 'function') {\n    // @ts-ignore\n    gtagCore = window[gtagFunctionName];\n  }\n\n  window[gtagFunctionName] = wrapGtag(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId);\n  return {\n    gtagCore: gtagCore,\n    wrappedGtag: window[gtagFunctionName]\n  };\n}\n/**\r\n * Returns first script tag in DOM matching our gtag url pattern.\r\n */\n\n\nfunction findGtagScriptOnPage() {\n  var scriptTags = window.document.getElementsByTagName('script');\n\n  for (var _i = 0, _a = Object.values(scriptTags); _i < _a.length; _i++) {\n    var tag = _a[_i];\n\n    if (tag.src && tag.src.includes(GTAG_URL)) {\n      return tag;\n    }\n  }\n\n  return null;\n}\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n\n\nvar _a;\n\nvar ERRORS = (_a = {}, _a[\"already-exists\"\n/* ALREADY_EXISTS */\n] = 'A Firebase Analytics instance with the appId {$id} ' + ' already exists. ' + 'Only one Firebase Analytics instance can be created for each appId.', _a[\"already-initialized\"\n/* ALREADY_INITIALIZED */\n] = 'Firebase Analytics has already been initialized.' + 'settings() must be called before initializing any Analytics instance' + 'or it will have no effect.', _a[\"interop-component-reg-failed\"\n/* INTEROP_COMPONENT_REG_FAILED */\n] = 'Firebase Analytics Interop Component failed to instantiate: {$reason}', _a[\"invalid-analytics-context\"\n/* INVALID_ANALYTICS_CONTEXT */\n] = 'Firebase Analytics is not supported in this environment. ' + 'Wrap initialization of analytics in analytics.isSupported() ' + 'to prevent initialization in unsupported environments. Details: {$errorInfo}', _a[\"indexeddb-unavailable\"\n/* INDEXEDDB_UNAVAILABLE */\n] = 'IndexedDB unavailable or restricted in this environment. ' + 'Wrap initialization of analytics in analytics.isSupported() ' + 'to prevent initialization in unsupported environments. Details: {$errorInfo}', _a[\"fetch-throttle\"\n/* FETCH_THROTTLE */\n] = 'The config fetch request timed out while in an exponential backoff state.' + ' Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.', _a[\"config-fetch-failed\"\n/* CONFIG_FETCH_FAILED */\n] = 'Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}', _a[\"no-api-key\"\n/* NO_API_KEY */\n] = 'The \"apiKey\" field is empty in the local Firebase config. Firebase Analytics requires this field to' + 'contain a valid API key.', _a[\"no-app-id\"\n/* NO_APP_ID */\n] = 'The \"appId\" field is empty in the local Firebase config. Firebase Analytics requires this field to' + 'contain a valid app ID.', _a);\nvar ERROR_FACTORY = new ErrorFactory('analytics', 'Analytics', ERRORS);\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n\n/**\r\n * Backoff factor for 503 errors, which we want to be conservative about\r\n * to avoid overloading servers. Each retry interval will be\r\n * BASE_INTERVAL_MILLIS * LONG_RETRY_FACTOR ^ retryCount, so the second one\r\n * will be ~30 seconds (with fuzzing).\r\n */\n\nvar LONG_RETRY_FACTOR = 30;\n/**\r\n * Base wait interval to multiplied by backoffFactor^backoffCount.\r\n */\n\nvar BASE_INTERVAL_MILLIS = 1000;\n/**\r\n * Stubbable retry data storage class.\r\n */\n\nvar RetryData = function () {\n  function RetryData(throttleMetadata, intervalMillis) {\n    if (throttleMetadata === void 0) {\n      throttleMetadata = {};\n    }\n\n    if (intervalMillis === void 0) {\n      intervalMillis = BASE_INTERVAL_MILLIS;\n    }\n\n    this.throttleMetadata = throttleMetadata;\n    this.intervalMillis = intervalMillis;\n  }\n\n  RetryData.prototype.getThrottleMetadata = function (appId) {\n    return this.throttleMetadata[appId];\n  };\n\n  RetryData.prototype.setThrottleMetadata = function (appId, metadata) {\n    this.throttleMetadata[appId] = metadata;\n  };\n\n  RetryData.prototype.deleteThrottleMetadata = function (appId) {\n    delete this.throttleMetadata[appId];\n  };\n\n  return RetryData;\n}();\n\nvar defaultRetryData = new RetryData();\n/**\r\n * Set GET request headers.\r\n * @param apiKey App API key.\r\n */\n\nfunction getHeaders(apiKey) {\n  return new Headers({\n    Accept: 'application/json',\n    'x-goog-api-key': apiKey\n  });\n}\n/**\r\n * Fetches dynamic config from backend.\r\n * @param app Firebase app to fetch config for.\r\n */\n\n\nfunction fetchDynamicConfig(appFields) {\n  var _a;\n\n  return __awaiter(this, void 0, void 0, function () {\n    var appId, apiKey, request, appUrl, response, errorMessage, jsonResponse;\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          appId = appFields.appId, apiKey = appFields.apiKey;\n          request = {\n            method: 'GET',\n            headers: getHeaders(apiKey)\n          };\n          appUrl = DYNAMIC_CONFIG_URL.replace('{app-id}', appId);\n          return [4\n          /*yield*/\n          , fetch(appUrl, request)];\n\n        case 1:\n          response = _b.sent();\n          if (!(response.status !== 200 && response.status !== 304)) return [3\n          /*break*/\n          , 6];\n          errorMessage = '';\n          _b.label = 2;\n\n        case 2:\n          _b.trys.push([2, 4,, 5]);\n\n          return [4\n          /*yield*/\n          , response.json()];\n\n        case 3:\n          jsonResponse = _b.sent();\n\n          if ((_a = jsonResponse.error) === null || _a === void 0 ? void 0 : _a.message) {\n            errorMessage = jsonResponse.error.message;\n          }\n\n          return [3\n          /*break*/\n          , 5];\n\n        case 4:\n          _b.sent();\n\n          return [3\n          /*break*/\n          , 5];\n\n        case 5:\n          throw ERROR_FACTORY.create(\"config-fetch-failed\"\n          /* CONFIG_FETCH_FAILED */\n          , {\n            httpStatus: response.status,\n            responseMessage: errorMessage\n          });\n\n        case 6:\n          return [2\n          /*return*/\n          , response.json()];\n      }\n    });\n  });\n}\n/**\r\n * Fetches dynamic config from backend, retrying if failed.\r\n * @param app Firebase app to fetch config for.\r\n */\n\n\nfunction fetchDynamicConfigWithRetry(app, // retryData and timeoutMillis are parameterized to allow passing a different value for testing.\nretryData, timeoutMillis) {\n  if (retryData === void 0) {\n    retryData = defaultRetryData;\n  }\n\n  return __awaiter(this, void 0, void 0, function () {\n    var _a, appId, apiKey, measurementId, throttleMetadata, signal;\n\n    var _this = this;\n\n    return __generator(this, function (_b) {\n      _a = app.options, appId = _a.appId, apiKey = _a.apiKey, measurementId = _a.measurementId;\n\n      if (!appId) {\n        throw ERROR_FACTORY.create(\"no-app-id\"\n        /* NO_APP_ID */\n        );\n      }\n\n      if (!apiKey) {\n        if (measurementId) {\n          return [2\n          /*return*/\n          , {\n            measurementId: measurementId,\n            appId: appId\n          }];\n        }\n\n        throw ERROR_FACTORY.create(\"no-api-key\"\n        /* NO_API_KEY */\n        );\n      }\n\n      throttleMetadata = retryData.getThrottleMetadata(appId) || {\n        backoffCount: 0,\n        throttleEndTimeMillis: Date.now()\n      };\n      signal = new AnalyticsAbortSignal();\n      setTimeout(function () {\n        return __awaiter(_this, void 0, void 0, function () {\n          return __generator(this, function (_a) {\n            // Note a very low delay, eg < 10ms, can elapse before listeners are initialized.\n            signal.abort();\n            return [2\n            /*return*/\n            ];\n          });\n        });\n      }, timeoutMillis !== undefined ? timeoutMillis : FETCH_TIMEOUT_MILLIS);\n      return [2\n      /*return*/\n      , attemptFetchDynamicConfigWithRetry({\n        appId: appId,\n        apiKey: apiKey,\n        measurementId: measurementId\n      }, throttleMetadata, signal, retryData)];\n    });\n  });\n}\n/**\r\n * Runs one retry attempt.\r\n * @param appFields Necessary app config fields.\r\n * @param throttleMetadata Ongoing metadata to determine throttling times.\r\n * @param signal Abort signal.\r\n */\n\n\nfunction attemptFetchDynamicConfigWithRetry(appFields, _a, signal, retryData // for testing\n) {\n  var throttleEndTimeMillis = _a.throttleEndTimeMillis,\n      backoffCount = _a.backoffCount;\n\n  if (retryData === void 0) {\n    retryData = defaultRetryData;\n  }\n\n  return __awaiter(this, void 0, void 0, function () {\n    var appId, measurementId, e_1, response, e_2, backoffMillis, throttleMetadata;\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          appId = appFields.appId, measurementId = appFields.measurementId;\n          _b.label = 1;\n\n        case 1:\n          _b.trys.push([1, 3,, 4]);\n\n          return [4\n          /*yield*/\n          , setAbortableTimeout(signal, throttleEndTimeMillis)];\n\n        case 2:\n          _b.sent();\n\n          return [3\n          /*break*/\n          , 4];\n\n        case 3:\n          e_1 = _b.sent();\n\n          if (measurementId) {\n            logger.warn(\"Timed out fetching this Firebase app's measurement ID from the server.\" + (\" Falling back to the measurement ID \" + measurementId) + (\" provided in the \\\"measurementId\\\" field in the local Firebase config. [\" + e_1.message + \"]\"));\n            return [2\n            /*return*/\n            , {\n              appId: appId,\n              measurementId: measurementId\n            }];\n          }\n\n          throw e_1;\n\n        case 4:\n          _b.trys.push([4, 6,, 7]);\n\n          return [4\n          /*yield*/\n          , fetchDynamicConfig(appFields)];\n\n        case 5:\n          response = _b.sent(); // Note the SDK only clears throttle state if response is success or non-retriable.\n\n          retryData.deleteThrottleMetadata(appId);\n          return [2\n          /*return*/\n          , response];\n\n        case 6:\n          e_2 = _b.sent();\n\n          if (!isRetriableError(e_2)) {\n            retryData.deleteThrottleMetadata(appId);\n\n            if (measurementId) {\n              logger.warn(\"Failed to fetch this Firebase app's measurement ID from the server.\" + (\" Falling back to the measurement ID \" + measurementId) + (\" provided in the \\\"measurementId\\\" field in the local Firebase config. [\" + e_2.message + \"]\"));\n              return [2\n              /*return*/\n              , {\n                appId: appId,\n                measurementId: measurementId\n              }];\n            } else {\n              throw e_2;\n            }\n          }\n\n          backoffMillis = Number(e_2.customData.httpStatus) === 503 ? calculateBackoffMillis(backoffCount, retryData.intervalMillis, LONG_RETRY_FACTOR) : calculateBackoffMillis(backoffCount, retryData.intervalMillis);\n          throttleMetadata = {\n            throttleEndTimeMillis: Date.now() + backoffMillis,\n            backoffCount: backoffCount + 1\n          }; // Persists state.\n\n          retryData.setThrottleMetadata(appId, throttleMetadata);\n          logger.debug(\"Calling attemptFetch again in \" + backoffMillis + \" millis\");\n          return [2\n          /*return*/\n          , attemptFetchDynamicConfigWithRetry(appFields, throttleMetadata, signal, retryData)];\n\n        case 7:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n/**\r\n * Supports waiting on a backoff by:\r\n *\r\n * <ul>\r\n *   <li>Promisifying setTimeout, so we can set a timeout in our Promise chain</li>\r\n *   <li>Listening on a signal bus for abort events, just like the Fetch API</li>\r\n *   <li>Failing in the same way the Fetch API fails, so timing out a live request and a throttled\r\n *       request appear the same.</li>\r\n * </ul>\r\n *\r\n * <p>Visible for testing.\r\n */\n\n\nfunction setAbortableTimeout(signal, throttleEndTimeMillis) {\n  return new Promise(function (resolve, reject) {\n    // Derives backoff from given end time, normalizing negative numbers to zero.\n    var backoffMillis = Math.max(throttleEndTimeMillis - Date.now(), 0);\n    var timeout = setTimeout(resolve, backoffMillis); // Adds listener, rather than sets onabort, because signal is a shared object.\n\n    signal.addEventListener(function () {\n      clearTimeout(timeout); // If the request completes before this timeout, the rejection has no effect.\n\n      reject(ERROR_FACTORY.create(\"fetch-throttle\"\n      /* FETCH_THROTTLE */\n      , {\n        throttleEndTimeMillis: throttleEndTimeMillis\n      }));\n    });\n  });\n}\n/**\r\n * Returns true if the {@link Error} indicates a fetch request may succeed later.\r\n */\n\n\nfunction isRetriableError(e) {\n  if (!(e instanceof FirebaseError) || !e.customData) {\n    return false;\n  } // Uses string index defined by ErrorData, which FirebaseError implements.\n\n\n  var httpStatus = Number(e.customData['httpStatus']);\n  return httpStatus === 429 || httpStatus === 500 || httpStatus === 503 || httpStatus === 504;\n}\n/**\r\n * Shims a minimal AbortSignal (copied from Remote Config).\r\n *\r\n * <p>AbortController's AbortSignal conveniently decouples fetch timeout logic from other aspects\r\n * of networking, such as retries. Firebase doesn't use AbortController enough to justify a\r\n * polyfill recommendation, like we do with the Fetch API, but this minimal shim can easily be\r\n * swapped out if/when we do.\r\n */\n\n\nvar AnalyticsAbortSignal = function () {\n  function AnalyticsAbortSignal() {\n    this.listeners = [];\n  }\n\n  AnalyticsAbortSignal.prototype.addEventListener = function (listener) {\n    this.listeners.push(listener);\n  };\n\n  AnalyticsAbortSignal.prototype.abort = function () {\n    this.listeners.forEach(function (listener) {\n      return listener();\n    });\n  };\n\n  return AnalyticsAbortSignal;\n}();\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n\n\nfunction validateIndexedDB() {\n  return __awaiter(this, void 0, void 0, function () {\n    var e_1;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (!!isIndexedDBAvailable()) return [3\n          /*break*/\n          , 1];\n          logger.warn(ERROR_FACTORY.create(\"indexeddb-unavailable\"\n          /* INDEXEDDB_UNAVAILABLE */\n          , {\n            errorInfo: 'IndexedDB is not available in this environment.'\n          }).message);\n          return [2\n          /*return*/\n          , false];\n\n        case 1:\n          _a.trys.push([1, 3,, 4]);\n\n          return [4\n          /*yield*/\n          , validateIndexedDBOpenable()];\n\n        case 2:\n          _a.sent();\n\n          return [3\n          /*break*/\n          , 4];\n\n        case 3:\n          e_1 = _a.sent();\n          logger.warn(ERROR_FACTORY.create(\"indexeddb-unavailable\"\n          /* INDEXEDDB_UNAVAILABLE */\n          , {\n            errorInfo: e_1\n          }).message);\n          return [2\n          /*return*/\n          , false];\n\n        case 4:\n          return [2\n          /*return*/\n          , true];\n      }\n    });\n  });\n}\n/**\r\n * Initialize the analytics instance in gtag.js by calling config command with fid.\r\n *\r\n * NOTE: We combine analytics initialization and setting fid together because we want fid to be\r\n * part of the `page_view` event that's sent during the initialization\r\n * @param app Firebase app\r\n * @param gtagCore The gtag function that's not wrapped.\r\n * @param dynamicConfigPromisesList Array of all dynamic config promises.\r\n * @param measurementIdToAppId Maps measurementID to appID.\r\n * @param installations FirebaseInstallations instance.\r\n *\r\n * @returns Measurement ID.\r\n */\n\n\nfunction initializeIds(app, dynamicConfigPromisesList, measurementIdToAppId, installations, gtagCore, dataLayerName) {\n  return __awaiter(this, void 0, void 0, function () {\n    var dynamicConfigPromise, fidPromise, _a, dynamicConfig, fid, configProperties;\n\n    var _b;\n\n    return __generator(this, function (_c) {\n      switch (_c.label) {\n        case 0:\n          dynamicConfigPromise = fetchDynamicConfigWithRetry(app); // Once fetched, map measurementIds to appId, for ease of lookup in wrapped gtag function.\n\n          dynamicConfigPromise.then(function (config) {\n            measurementIdToAppId[config.measurementId] = config.appId;\n\n            if (app.options.measurementId && config.measurementId !== app.options.measurementId) {\n              logger.warn(\"The measurement ID in the local Firebase config (\" + app.options.measurementId + \")\" + (\" does not match the measurement ID fetched from the server (\" + config.measurementId + \").\") + \" To ensure analytics events are always sent to the correct Analytics property,\" + \" update the\" + \" measurement ID field in the local config or remove it from the local config.\");\n            }\n          }).catch(function (e) {\n            return logger.error(e);\n          }); // Add to list to track state of all dynamic config promises.\n\n          dynamicConfigPromisesList.push(dynamicConfigPromise);\n          fidPromise = validateIndexedDB().then(function (envIsValid) {\n            if (envIsValid) {\n              return installations.getId();\n            } else {\n              return undefined;\n            }\n          });\n          return [4\n          /*yield*/\n          , Promise.all([dynamicConfigPromise, fidPromise])];\n\n        case 1:\n          _a = _c.sent(), dynamicConfig = _a[0], fid = _a[1]; // Detect if user has already put the gtag <script> tag on this page.\n\n          if (!findGtagScriptOnPage()) {\n            insertScriptTag(dataLayerName, dynamicConfig.measurementId);\n          } // This command initializes gtag.js and only needs to be called once for the entire web app,\n          // but since it is idempotent, we can call it multiple times.\n          // We keep it together with other initialization logic for better code structure.\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n\n\n          gtagCore('js', new Date());\n          configProperties = (_b = {}, // guard against developers accidentally setting properties with prefix `firebase_`\n          _b[ORIGIN_KEY] = 'firebase', _b.update = true, _b);\n\n          if (fid != null) {\n            configProperties[GA_FID_KEY] = fid;\n          } // It should be the first config command called on this GA-ID\n          // Initialize this GA-ID and set FID on it using the gtag config API.\n          // Note: This will trigger a page_view event unless 'send_page_view' is set to false in\n          // `configProperties`.\n\n\n          gtagCore(GtagCommand.CONFIG, dynamicConfig.measurementId, configProperties);\n          return [2\n          /*return*/\n          , dynamicConfig.measurementId];\n      }\n    });\n  });\n}\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\n\n/**\r\n * Maps appId to full initialization promise. Wrapped gtag calls must wait on\r\n * all or some of these, depending on the call's `send_to` param and the status\r\n * of the dynamic config fetches (see below).\r\n */\n\n\nvar initializationPromisesMap = {};\n/**\r\n * List of dynamic config fetch promises. In certain cases, wrapped gtag calls\r\n * wait on all these to be complete in order to determine if it can selectively\r\n * wait for only certain initialization (FID) promises or if it must wait for all.\r\n */\n\nvar dynamicConfigPromisesList = [];\n/**\r\n * Maps fetched measurementIds to appId. Populated when the app's dynamic config\r\n * fetch completes. If already populated, gtag config calls can use this to\r\n * selectively wait for only this app's initialization promise (FID) instead of all\r\n * initialization promises.\r\n */\n\nvar measurementIdToAppId = {};\n/**\r\n * Name for window global data layer array used by GA: defaults to 'dataLayer'.\r\n */\n\nvar dataLayerName = 'dataLayer';\n/**\r\n * Name for window global gtag function used by GA: defaults to 'gtag'.\r\n */\n\nvar gtagName = 'gtag';\n/**\r\n * Reproduction of standard gtag function or reference to existing\r\n * gtag function on window object.\r\n */\n\nvar gtagCoreFunction;\n/**\r\n * Wrapper around gtag function that ensures FID is sent with all\r\n * relevant event and config calls.\r\n */\n\nvar wrappedGtagFunction;\n/**\r\n * Flag to ensure page initialization steps (creation or wrapping of\r\n * dataLayer and gtag script) are only run once per page load.\r\n */\n\nvar globalInitDone = false;\n/**\r\n * For testing\r\n */\n\nfunction resetGlobalVars(newGlobalInitDone, newInitializationPromisesMap, newDynamicPromises) {\n  if (newGlobalInitDone === void 0) {\n    newGlobalInitDone = false;\n  }\n\n  if (newInitializationPromisesMap === void 0) {\n    newInitializationPromisesMap = {};\n  }\n\n  if (newDynamicPromises === void 0) {\n    newDynamicPromises = [];\n  }\n\n  globalInitDone = newGlobalInitDone;\n  initializationPromisesMap = newInitializationPromisesMap;\n  dynamicConfigPromisesList = newDynamicPromises;\n  dataLayerName = 'dataLayer';\n  gtagName = 'gtag';\n}\n/**\r\n * For testing\r\n */\n\n\nfunction getGlobalVars() {\n  return {\n    initializationPromisesMap: initializationPromisesMap,\n    dynamicConfigPromisesList: dynamicConfigPromisesList\n  };\n}\n/**\r\n * This must be run before calling firebase.analytics() or it won't\r\n * have any effect.\r\n * @param options Custom gtag and dataLayer names.\r\n */\n\n\nfunction settings(options) {\n  if (globalInitDone) {\n    throw ERROR_FACTORY.create(\"already-initialized\"\n    /* ALREADY_INITIALIZED */\n    );\n  }\n\n  if (options.dataLayerName) {\n    dataLayerName = options.dataLayerName;\n  }\n\n  if (options.gtagName) {\n    gtagName = options.gtagName;\n  }\n}\n/**\r\n * Returns true if no environment mismatch is found.\r\n * If environment mismatches are found, throws an INVALID_ANALYTICS_CONTEXT\r\n * error that also lists details for each mismatch found.\r\n */\n\n\nfunction warnOnBrowserContextMismatch() {\n  var mismatchedEnvMessages = [];\n\n  if (isBrowserExtension()) {\n    mismatchedEnvMessages.push('This is a browser extension environment.');\n  }\n\n  if (!areCookiesEnabled()) {\n    mismatchedEnvMessages.push('Cookies are not available.');\n  }\n\n  if (mismatchedEnvMessages.length > 0) {\n    var details = mismatchedEnvMessages.map(function (message, index) {\n      return \"(\" + (index + 1) + \") \" + message;\n    }).join(' ');\n    var err = ERROR_FACTORY.create(\"invalid-analytics-context\"\n    /* INVALID_ANALYTICS_CONTEXT */\n    , {\n      errorInfo: details\n    });\n    logger.warn(err.message);\n  }\n}\n\nfunction factory(app, installations) {\n  warnOnBrowserContextMismatch();\n  var appId = app.options.appId;\n\n  if (!appId) {\n    throw ERROR_FACTORY.create(\"no-app-id\"\n    /* NO_APP_ID */\n    );\n  }\n\n  if (!app.options.apiKey) {\n    if (app.options.measurementId) {\n      logger.warn(\"The \\\"apiKey\\\" field is empty in the local Firebase config. This is needed to fetch the latest\" + (\" measurement ID for this Firebase app. Falling back to the measurement ID \" + app.options.measurementId) + \" provided in the \\\"measurementId\\\" field in the local Firebase config.\");\n    } else {\n      throw ERROR_FACTORY.create(\"no-api-key\"\n      /* NO_API_KEY */\n      );\n    }\n  }\n\n  if (initializationPromisesMap[appId] != null) {\n    throw ERROR_FACTORY.create(\"already-exists\"\n    /* ALREADY_EXISTS */\n    , {\n      id: appId\n    });\n  }\n\n  if (!globalInitDone) {\n    // Steps here should only be done once per page: creation or wrapping\n    // of dataLayer and global gtag function.\n    getOrCreateDataLayer(dataLayerName);\n\n    var _a = wrapOrCreateGtag(initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, dataLayerName, gtagName),\n        wrappedGtag = _a.wrappedGtag,\n        gtagCore = _a.gtagCore;\n\n    wrappedGtagFunction = wrappedGtag;\n    gtagCoreFunction = gtagCore;\n    globalInitDone = true;\n  } // Async but non-blocking.\n  // This map reflects the completion state of all promises for each appId.\n\n\n  initializationPromisesMap[appId] = initializeIds(app, dynamicConfigPromisesList, measurementIdToAppId, installations, gtagCoreFunction, dataLayerName);\n  var analyticsInstance = {\n    app: app,\n    // Public methods return void for API simplicity and to better match gtag,\n    // while internal implementations return promises.\n    logEvent: function (eventName, eventParams, options) {\n      logEvent(wrappedGtagFunction, initializationPromisesMap[appId], eventName, eventParams, options).catch(function (e) {\n        return logger.error(e);\n      });\n    },\n    setCurrentScreen: function (screenName, options) {\n      setCurrentScreen(wrappedGtagFunction, initializationPromisesMap[appId], screenName, options).catch(function (e) {\n        return logger.error(e);\n      });\n    },\n    setUserId: function (id, options) {\n      setUserId(wrappedGtagFunction, initializationPromisesMap[appId], id, options).catch(function (e) {\n        return logger.error(e);\n      });\n    },\n    setUserProperties: function (properties, options) {\n      setUserProperties(wrappedGtagFunction, initializationPromisesMap[appId], properties, options).catch(function (e) {\n        return logger.error(e);\n      });\n    },\n    setAnalyticsCollectionEnabled: function (enabled) {\n      setAnalyticsCollectionEnabled(initializationPromisesMap[appId], enabled).catch(function (e) {\n        return logger.error(e);\n      });\n    },\n    INTERNAL: {\n      delete: function () {\n        delete initializationPromisesMap[appId];\n        return Promise.resolve();\n      }\n    }\n  };\n  return analyticsInstance;\n}\n\nvar name = \"@firebase/analytics\";\nvar version = \"0.6.16\";\n/**\r\n * Type constant for Firebase Analytics.\r\n */\n\nvar ANALYTICS_TYPE = 'analytics';\n\nfunction registerAnalytics(instance) {\n  instance.INTERNAL.registerComponent(new Component(ANALYTICS_TYPE, function (container) {\n    // getImmediate for FirebaseApp will always succeed\n    var app = container.getProvider('app').getImmediate();\n    var installations = container.getProvider('installations').getImmediate();\n    return factory(app, installations);\n  }, \"PUBLIC\"\n  /* PUBLIC */\n  ).setServiceProps({\n    settings: settings,\n    EventName: EventName,\n    isSupported: isSupported\n  }));\n  instance.INTERNAL.registerComponent(new Component('analytics-internal', internalFactory, \"PRIVATE\"\n  /* PRIVATE */\n  ));\n  instance.registerVersion(name, version);\n\n  function internalFactory(container) {\n    try {\n      var analytics = container.getProvider(ANALYTICS_TYPE).getImmediate();\n      return {\n        logEvent: analytics.logEvent\n      };\n    } catch (e) {\n      throw ERROR_FACTORY.create(\"interop-component-reg-failed\"\n      /* INTEROP_COMPONENT_REG_FAILED */\n      , {\n        reason: e\n      });\n    }\n  }\n}\n\nregisterAnalytics(firebase);\n/**\r\n * this is a public static method provided to users that wraps four different checks:\r\n *\r\n * 1. check if it's not a browser extension environment.\r\n * 1. check if cookie is enabled in current browser.\r\n * 3. check if IndexedDB is supported by the browser environment.\r\n * 4. check if the current browser context is valid for using IndexedDB.\r\n *\r\n */\n\nfunction isSupported() {\n  return __awaiter(this, void 0, void 0, function () {\n    var isDBOpenable;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (isBrowserExtension()) {\n            return [2\n            /*return*/\n            , false];\n          }\n\n          if (!areCookiesEnabled()) {\n            return [2\n            /*return*/\n            , false];\n          }\n\n          if (!isIndexedDBAvailable()) {\n            return [2\n            /*return*/\n            , false];\n          }\n\n          _a.label = 1;\n\n        case 1:\n          _a.trys.push([1, 3,, 4]);\n\n          return [4\n          /*yield*/\n          , validateIndexedDBOpenable()];\n\n        case 2:\n          isDBOpenable = _a.sent();\n          return [2\n          /*return*/\n          , isDBOpenable];\n\n        case 3:\n          _a.sent();\n\n          return [2\n          /*return*/\n          , false];\n\n        case 4:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n\nexport { factory, getGlobalVars, registerAnalytics, resetGlobalVars, settings }; //# sourceMappingURL=index.esm.js.map","map":{"version":3,"sources":["C:/Programming/web/ng/libraries/rxfire-extended/node_modules/@firebase/analytics/dist/index.esm.js"],"names":["__awaiter","__generator","__assign","firebase","Logger","ErrorFactory","calculateBackoffMillis","FirebaseError","validateIndexedDBOpenable","isIndexedDBAvailable","isBrowserExtension","areCookiesEnabled","Component","GA_FID_KEY","ORIGIN_KEY","FETCH_TIMEOUT_MILLIS","DYNAMIC_CONFIG_URL","GTAG_URL","GtagCommand","EventName","logEvent","gtagFunction","initializationPromise","eventName","eventParams","options","measurementId","params","_a","label","global","EVENT","sent","setCurrentScreen","screenName","SET","Promise","resolve","CONFIG","update","setUserId","id","setUserProperties","properties","flatProperties","_i","key","_b","Object","keys","length","setAnalyticsCollectionEnabled","enabled","window","logger","insertScriptTag","dataLayerName","script","document","createElement","src","async","head","appendChild","getOrCreateDataLayer","dataLayer","Array","isArray","gtagOnConfig","gtagCore","initializationPromisesMap","dynamicConfigPromisesList","measurementIdToAppId","gtagParams","correspondingAppId","dynamicConfigResults","foundConfig","e_1","trys","push","all","find","config","appId","error","gtagOnEvent","initializationPromisesToWaitFor","gaSendToList","_loop_1","gaSendToList_1","sendToId","state_1","e_2","values","wrapGtag","gtagWrapper","command","idOrNameOrParams","e_3","wrapOrCreateGtag","gtagFunctionName","_args","arguments","wrappedGtag","findGtagScriptOnPage","scriptTags","getElementsByTagName","tag","includes","ERRORS","ERROR_FACTORY","LONG_RETRY_FACTOR","BASE_INTERVAL_MILLIS","RetryData","throttleMetadata","intervalMillis","prototype","getThrottleMetadata","setThrottleMetadata","metadata","deleteThrottleMetadata","defaultRetryData","getHeaders","apiKey","Headers","Accept","fetchDynamicConfig","appFields","request","appUrl","response","errorMessage","jsonResponse","method","headers","replace","fetch","status","json","message","create","httpStatus","responseMessage","fetchDynamicConfigWithRetry","app","retryData","timeoutMillis","signal","_this","backoffCount","throttleEndTimeMillis","Date","now","AnalyticsAbortSignal","setTimeout","abort","undefined","attemptFetchDynamicConfigWithRetry","backoffMillis","setAbortableTimeout","warn","isRetriableError","Number","customData","debug","reject","Math","max","timeout","addEventListener","clearTimeout","e","listeners","listener","forEach","validateIndexedDB","errorInfo","initializeIds","installations","dynamicConfigPromise","fidPromise","dynamicConfig","fid","configProperties","_c","then","catch","envIsValid","getId","gtagName","gtagCoreFunction","wrappedGtagFunction","globalInitDone","resetGlobalVars","newGlobalInitDone","newInitializationPromisesMap","newDynamicPromises","getGlobalVars","settings","warnOnBrowserContextMismatch","mismatchedEnvMessages","details","map","index","join","err","factory","analyticsInstance","INTERNAL","delete","name","version","ANALYTICS_TYPE","registerAnalytics","instance","registerComponent","container","getProvider","getImmediate","setServiceProps","isSupported","internalFactory","registerVersion","analytics","reason","isDBOpenable"],"mappings":"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","sourcesContent":["import { __awaiter, __generator, __assign } from 'tslib';\nimport firebase from '@firebase/app';\nimport '@firebase/installations';\nimport { Logger } from '@firebase/logger';\nimport { ErrorFactory, calculateBackoffMillis, FirebaseError, validateIndexedDBOpenable, isIndexedDBAvailable, isBrowserExtension, areCookiesEnabled } from '@firebase/util';\nimport { Component } from '@firebase/component';\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n// Key to attach FID to in gtag params.\r\nvar GA_FID_KEY = 'firebase_id';\r\nvar ORIGIN_KEY = 'origin';\r\nvar FETCH_TIMEOUT_MILLIS = 60 * 1000;\r\nvar DYNAMIC_CONFIG_URL = 'https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig';\r\nvar GTAG_URL = 'https://www.googletagmanager.com/gtag/js';\r\nvar GtagCommand;\r\n(function (GtagCommand) {\r\n    GtagCommand[\"EVENT\"] = \"event\";\r\n    GtagCommand[\"SET\"] = \"set\";\r\n    GtagCommand[\"CONFIG\"] = \"config\";\r\n})(GtagCommand || (GtagCommand = {}));\r\n/**\r\n * Officially recommended event names for gtag.js\r\n * Any other string is also allowed.\r\n *\r\n * @public\r\n */\r\nvar EventName;\r\n(function (EventName) {\r\n    EventName[\"ADD_SHIPPING_INFO\"] = \"add_shipping_info\";\r\n    EventName[\"ADD_PAYMENT_INFO\"] = \"add_payment_info\";\r\n    EventName[\"ADD_TO_CART\"] = \"add_to_cart\";\r\n    EventName[\"ADD_TO_WISHLIST\"] = \"add_to_wishlist\";\r\n    EventName[\"BEGIN_CHECKOUT\"] = \"begin_checkout\";\r\n    /**\r\n     * @deprecated\r\n     * This event name is deprecated and is unsupported in updated\r\n     * Enhanced Ecommerce reports.\r\n     */\r\n    EventName[\"CHECKOUT_PROGRESS\"] = \"checkout_progress\";\r\n    EventName[\"EXCEPTION\"] = \"exception\";\r\n    EventName[\"GENERATE_LEAD\"] = \"generate_lead\";\r\n    EventName[\"LOGIN\"] = \"login\";\r\n    EventName[\"PAGE_VIEW\"] = \"page_view\";\r\n    EventName[\"PURCHASE\"] = \"purchase\";\r\n    EventName[\"REFUND\"] = \"refund\";\r\n    EventName[\"REMOVE_FROM_CART\"] = \"remove_from_cart\";\r\n    EventName[\"SCREEN_VIEW\"] = \"screen_view\";\r\n    EventName[\"SEARCH\"] = \"search\";\r\n    EventName[\"SELECT_CONTENT\"] = \"select_content\";\r\n    EventName[\"SELECT_ITEM\"] = \"select_item\";\r\n    EventName[\"SELECT_PROMOTION\"] = \"select_promotion\";\r\n    /** @deprecated */\r\n    EventName[\"SET_CHECKOUT_OPTION\"] = \"set_checkout_option\";\r\n    EventName[\"SHARE\"] = \"share\";\r\n    EventName[\"SIGN_UP\"] = \"sign_up\";\r\n    EventName[\"TIMING_COMPLETE\"] = \"timing_complete\";\r\n    EventName[\"VIEW_CART\"] = \"view_cart\";\r\n    EventName[\"VIEW_ITEM\"] = \"view_item\";\r\n    EventName[\"VIEW_ITEM_LIST\"] = \"view_item_list\";\r\n    EventName[\"VIEW_PROMOTION\"] = \"view_promotion\";\r\n    EventName[\"VIEW_SEARCH_RESULTS\"] = \"view_search_results\";\r\n})(EventName || (EventName = {}));\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/**\r\n * Logs an analytics event through the Firebase SDK.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param eventName Google Analytics event name, choose from standard list or use a custom string.\r\n * @param eventParams Analytics event parameters.\r\n */\r\nfunction logEvent(gtagFunction, initializationPromise, eventName, eventParams, options) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var measurementId, params;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (!(options && options.global)) return [3 /*break*/, 1];\r\n                    gtagFunction(GtagCommand.EVENT, eventName, eventParams);\r\n                    return [2 /*return*/];\r\n                case 1: return [4 /*yield*/, initializationPromise];\r\n                case 2:\r\n                    measurementId = _a.sent();\r\n                    params = __assign(__assign({}, eventParams), { 'send_to': measurementId });\r\n                    gtagFunction(GtagCommand.EVENT, eventName, params);\r\n                    _a.label = 3;\r\n                case 3: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Set screen_name parameter for this Google Analytics ID.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param screenName Screen name string to set.\r\n */\r\nfunction setCurrentScreen(gtagFunction, initializationPromise, screenName, options) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var measurementId;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (!(options && options.global)) return [3 /*break*/, 1];\r\n                    gtagFunction(GtagCommand.SET, { 'screen_name': screenName });\r\n                    return [2 /*return*/, Promise.resolve()];\r\n                case 1: return [4 /*yield*/, initializationPromise];\r\n                case 2:\r\n                    measurementId = _a.sent();\r\n                    gtagFunction(GtagCommand.CONFIG, measurementId, {\r\n                        update: true,\r\n                        'screen_name': screenName\r\n                    });\r\n                    _a.label = 3;\r\n                case 3: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Set user_id parameter for this Google Analytics ID.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param id User ID string to set\r\n */\r\nfunction setUserId(gtagFunction, initializationPromise, id, options) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var measurementId;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (!(options && options.global)) return [3 /*break*/, 1];\r\n                    gtagFunction(GtagCommand.SET, { 'user_id': id });\r\n                    return [2 /*return*/, Promise.resolve()];\r\n                case 1: return [4 /*yield*/, initializationPromise];\r\n                case 2:\r\n                    measurementId = _a.sent();\r\n                    gtagFunction(GtagCommand.CONFIG, measurementId, {\r\n                        update: true,\r\n                        'user_id': id\r\n                    });\r\n                    _a.label = 3;\r\n                case 3: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Set all other user properties other than user_id and screen_name.\r\n *\r\n * @param gtagFunction Wrapped gtag function that waits for fid to be set before sending an event\r\n * @param properties Map of user properties to set\r\n */\r\nfunction setUserProperties(gtagFunction, initializationPromise, properties, options) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var flatProperties, _i, _a, key, measurementId;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    if (!(options && options.global)) return [3 /*break*/, 1];\r\n                    flatProperties = {};\r\n                    for (_i = 0, _a = Object.keys(properties); _i < _a.length; _i++) {\r\n                        key = _a[_i];\r\n                        // use dot notation for merge behavior in gtag.js\r\n                        flatProperties[\"user_properties.\" + key] = properties[key];\r\n                    }\r\n                    gtagFunction(GtagCommand.SET, flatProperties);\r\n                    return [2 /*return*/, Promise.resolve()];\r\n                case 1: return [4 /*yield*/, initializationPromise];\r\n                case 2:\r\n                    measurementId = _b.sent();\r\n                    gtagFunction(GtagCommand.CONFIG, measurementId, {\r\n                        update: true,\r\n                        'user_properties': properties\r\n                    });\r\n                    _b.label = 3;\r\n                case 3: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Set whether collection is enabled for this ID.\r\n *\r\n * @param enabled If true, collection is enabled for this ID.\r\n */\r\nfunction setAnalyticsCollectionEnabled(initializationPromise, enabled) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var measurementId;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, initializationPromise];\r\n                case 1:\r\n                    measurementId = _a.sent();\r\n                    window[\"ga-disable-\" + measurementId] = !enabled;\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar logger = new Logger('@firebase/analytics');\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/**\r\n * Inserts gtag script tag into the page to asynchronously download gtag.\r\n * @param dataLayerName Name of datalayer (most often the default, \"_dataLayer\").\r\n */\r\nfunction insertScriptTag(dataLayerName, measurementId) {\r\n    var script = document.createElement('script');\r\n    script.src = GTAG_URL + \"?l=\" + dataLayerName + \"&id=\" + measurementId;\r\n    script.async = true;\r\n    document.head.appendChild(script);\r\n}\r\n/**\r\n * Get reference to, or create, global datalayer.\r\n * @param dataLayerName Name of datalayer (most often the default, \"_dataLayer\").\r\n */\r\nfunction getOrCreateDataLayer(dataLayerName) {\r\n    // Check for existing dataLayer and create if needed.\r\n    var dataLayer = [];\r\n    if (Array.isArray(window[dataLayerName])) {\r\n        dataLayer = window[dataLayerName];\r\n    }\r\n    else {\r\n        window[dataLayerName] = dataLayer;\r\n    }\r\n    return dataLayer;\r\n}\r\n/**\r\n * Wrapped gtag logic when gtag is called with 'config' command.\r\n *\r\n * @param gtagCore Basic gtag function that just appends to dataLayer.\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementIdToAppId Map of GA measurementIDs to corresponding Firebase appId.\r\n * @param measurementId GA Measurement ID to set config for.\r\n * @param gtagParams Gtag config params to set.\r\n */\r\nfunction gtagOnConfig(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, measurementId, gtagParams) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var correspondingAppId, dynamicConfigResults, foundConfig, e_1;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    correspondingAppId = measurementIdToAppId[measurementId];\r\n                    _a.label = 1;\r\n                case 1:\r\n                    _a.trys.push([1, 7, , 8]);\r\n                    if (!correspondingAppId) return [3 /*break*/, 3];\r\n                    return [4 /*yield*/, initializationPromisesMap[correspondingAppId]];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [3 /*break*/, 6];\r\n                case 3: return [4 /*yield*/, Promise.all(dynamicConfigPromisesList)];\r\n                case 4:\r\n                    dynamicConfigResults = _a.sent();\r\n                    foundConfig = dynamicConfigResults.find(function (config) { return config.measurementId === measurementId; });\r\n                    if (!foundConfig) return [3 /*break*/, 6];\r\n                    return [4 /*yield*/, initializationPromisesMap[foundConfig.appId]];\r\n                case 5:\r\n                    _a.sent();\r\n                    _a.label = 6;\r\n                case 6: return [3 /*break*/, 8];\r\n                case 7:\r\n                    e_1 = _a.sent();\r\n                    logger.error(e_1);\r\n                    return [3 /*break*/, 8];\r\n                case 8:\r\n                    gtagCore(GtagCommand.CONFIG, measurementId, gtagParams);\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Wrapped gtag logic when gtag is called with 'event' command.\r\n *\r\n * @param gtagCore Basic gtag function that just appends to dataLayer.\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementId GA Measurement ID to log event to.\r\n * @param gtagParams Params to log with this event.\r\n */\r\nfunction gtagOnEvent(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementId, gtagParams) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var initializationPromisesToWaitFor, gaSendToList, dynamicConfigResults, _loop_1, _i, gaSendToList_1, sendToId, state_1, e_2;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    _a.trys.push([0, 4, , 5]);\r\n                    initializationPromisesToWaitFor = [];\r\n                    if (!(gtagParams && gtagParams['send_to'])) return [3 /*break*/, 2];\r\n                    gaSendToList = gtagParams['send_to'];\r\n                    // Make it an array if is isn't, so it can be dealt with the same way.\r\n                    if (!Array.isArray(gaSendToList)) {\r\n                        gaSendToList = [gaSendToList];\r\n                    }\r\n                    return [4 /*yield*/, Promise.all(dynamicConfigPromisesList)];\r\n                case 1:\r\n                    dynamicConfigResults = _a.sent();\r\n                    _loop_1 = function (sendToId) {\r\n                        // Any fetched dynamic measurement ID that matches this 'send_to' ID\r\n                        var foundConfig = dynamicConfigResults.find(function (config) { return config.measurementId === sendToId; });\r\n                        var initializationPromise = foundConfig && initializationPromisesMap[foundConfig.appId];\r\n                        if (initializationPromise) {\r\n                            initializationPromisesToWaitFor.push(initializationPromise);\r\n                        }\r\n                        else {\r\n                            // Found an item in 'send_to' that is not associated\r\n                            // directly with an FID, possibly a group.  Empty this array,\r\n                            // exit the loop early, and let it get populated below.\r\n                            initializationPromisesToWaitFor = [];\r\n                            return \"break\";\r\n                        }\r\n                    };\r\n                    for (_i = 0, gaSendToList_1 = gaSendToList; _i < gaSendToList_1.length; _i++) {\r\n                        sendToId = gaSendToList_1[_i];\r\n                        state_1 = _loop_1(sendToId);\r\n                        if (state_1 === \"break\")\r\n                            break;\r\n                    }\r\n                    _a.label = 2;\r\n                case 2:\r\n                    // This will be unpopulated if there was no 'send_to' field , or\r\n                    // if not all entries in the 'send_to' field could be mapped to\r\n                    // a FID. In these cases, wait on all pending initialization promises.\r\n                    if (initializationPromisesToWaitFor.length === 0) {\r\n                        initializationPromisesToWaitFor = Object.values(initializationPromisesMap);\r\n                    }\r\n                    // Run core gtag function with args after all relevant initialization\r\n                    // promises have been resolved.\r\n                    return [4 /*yield*/, Promise.all(initializationPromisesToWaitFor)];\r\n                case 3:\r\n                    // Run core gtag function with args after all relevant initialization\r\n                    // promises have been resolved.\r\n                    _a.sent();\r\n                    // Workaround for http://b/141370449 - third argument cannot be undefined.\r\n                    gtagCore(GtagCommand.EVENT, measurementId, gtagParams || {});\r\n                    return [3 /*break*/, 5];\r\n                case 4:\r\n                    e_2 = _a.sent();\r\n                    logger.error(e_2);\r\n                    return [3 /*break*/, 5];\r\n                case 5: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Wraps a standard gtag function with extra code to wait for completion of\r\n * relevant initialization promises before sending requests.\r\n *\r\n * @param gtagCore Basic gtag function that just appends to dataLayer.\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementIdToAppId Map of GA measurementIDs to corresponding Firebase appId.\r\n */\r\nfunction wrapGtag(gtagCore, \r\n/**\r\n * Allows wrapped gtag calls to wait on whichever intialization promises are required,\r\n * depending on the contents of the gtag params' `send_to` field, if any.\r\n */\r\ninitializationPromisesMap, \r\n/**\r\n * Wrapped gtag calls sometimes require all dynamic config fetches to have returned\r\n * before determining what initialization promises (which include FIDs) to wait for.\r\n */\r\ndynamicConfigPromisesList, \r\n/**\r\n * Wrapped gtag config calls can narrow down which initialization promise (with FID)\r\n * to wait for if the measurementId is already fetched, by getting the corresponding appId,\r\n * which is the key for the initialization promises map.\r\n */\r\nmeasurementIdToAppId) {\r\n    /**\r\n     * Wrapper around gtag that ensures FID is sent with gtag calls.\r\n     * @param command Gtag command type.\r\n     * @param idOrNameOrParams Measurement ID if command is EVENT/CONFIG, params if command is SET.\r\n     * @param gtagParams Params if event is EVENT/CONFIG.\r\n     */\r\n    function gtagWrapper(command, idOrNameOrParams, gtagParams) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var e_3;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _a.trys.push([0, 6, , 7]);\r\n                        if (!(command === GtagCommand.EVENT)) return [3 /*break*/, 2];\r\n                        // If EVENT, second arg must be measurementId.\r\n                        return [4 /*yield*/, gtagOnEvent(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, idOrNameOrParams, gtagParams)];\r\n                    case 1:\r\n                        // If EVENT, second arg must be measurementId.\r\n                        _a.sent();\r\n                        return [3 /*break*/, 5];\r\n                    case 2:\r\n                        if (!(command === GtagCommand.CONFIG)) return [3 /*break*/, 4];\r\n                        // If CONFIG, second arg must be measurementId.\r\n                        return [4 /*yield*/, gtagOnConfig(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, idOrNameOrParams, gtagParams)];\r\n                    case 3:\r\n                        // If CONFIG, second arg must be measurementId.\r\n                        _a.sent();\r\n                        return [3 /*break*/, 5];\r\n                    case 4:\r\n                        // If SET, second arg must be params.\r\n                        gtagCore(GtagCommand.SET, idOrNameOrParams);\r\n                        _a.label = 5;\r\n                    case 5: return [3 /*break*/, 7];\r\n                    case 6:\r\n                        e_3 = _a.sent();\r\n                        logger.error(e_3);\r\n                        return [3 /*break*/, 7];\r\n                    case 7: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    return gtagWrapper;\r\n}\r\n/**\r\n * Creates global gtag function or wraps existing one if found.\r\n * This wrapped function attaches Firebase instance ID (FID) to gtag 'config' and\r\n * 'event' calls that belong to the GAID associated with this Firebase instance.\r\n *\r\n * @param initializationPromisesMap Map of appIds to their initialization promises.\r\n * @param dynamicConfigPromisesList Array of dynamic config fetch promises.\r\n * @param measurementIdToAppId Map of GA measurementIDs to corresponding Firebase appId.\r\n * @param dataLayerName Name of global GA datalayer array.\r\n * @param gtagFunctionName Name of global gtag function (\"gtag\" if not user-specified).\r\n */\r\nfunction wrapOrCreateGtag(initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, dataLayerName, gtagFunctionName) {\r\n    // Create a basic core gtag function\r\n    var gtagCore = function () {\r\n        var _args = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            _args[_i] = arguments[_i];\r\n        }\r\n        // Must push IArguments object, not an array.\r\n        window[dataLayerName].push(arguments);\r\n    };\r\n    // Replace it with existing one if found\r\n    if (window[gtagFunctionName] &&\r\n        typeof window[gtagFunctionName] === 'function') {\r\n        // @ts-ignore\r\n        gtagCore = window[gtagFunctionName];\r\n    }\r\n    window[gtagFunctionName] = wrapGtag(gtagCore, initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId);\r\n    return {\r\n        gtagCore: gtagCore,\r\n        wrappedGtag: window[gtagFunctionName]\r\n    };\r\n}\r\n/**\r\n * Returns first script tag in DOM matching our gtag url pattern.\r\n */\r\nfunction findGtagScriptOnPage() {\r\n    var scriptTags = window.document.getElementsByTagName('script');\r\n    for (var _i = 0, _a = Object.values(scriptTags); _i < _a.length; _i++) {\r\n        var tag = _a[_i];\r\n        if (tag.src && tag.src.includes(GTAG_URL)) {\r\n            return tag;\r\n        }\r\n    }\r\n    return null;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar _a;\r\nvar ERRORS = (_a = {},\r\n    _a[\"already-exists\" /* ALREADY_EXISTS */] = 'A Firebase Analytics instance with the appId {$id} ' +\r\n        ' already exists. ' +\r\n        'Only one Firebase Analytics instance can be created for each appId.',\r\n    _a[\"already-initialized\" /* ALREADY_INITIALIZED */] = 'Firebase Analytics has already been initialized.' +\r\n        'settings() must be called before initializing any Analytics instance' +\r\n        'or it will have no effect.',\r\n    _a[\"interop-component-reg-failed\" /* INTEROP_COMPONENT_REG_FAILED */] = 'Firebase Analytics Interop Component failed to instantiate: {$reason}',\r\n    _a[\"invalid-analytics-context\" /* INVALID_ANALYTICS_CONTEXT */] = 'Firebase Analytics is not supported in this environment. ' +\r\n        'Wrap initialization of analytics in analytics.isSupported() ' +\r\n        'to prevent initialization in unsupported environments. Details: {$errorInfo}',\r\n    _a[\"indexeddb-unavailable\" /* INDEXEDDB_UNAVAILABLE */] = 'IndexedDB unavailable or restricted in this environment. ' +\r\n        'Wrap initialization of analytics in analytics.isSupported() ' +\r\n        'to prevent initialization in unsupported environments. Details: {$errorInfo}',\r\n    _a[\"fetch-throttle\" /* FETCH_THROTTLE */] = 'The config fetch request timed out while in an exponential backoff state.' +\r\n        ' Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.',\r\n    _a[\"config-fetch-failed\" /* CONFIG_FETCH_FAILED */] = 'Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}',\r\n    _a[\"no-api-key\" /* NO_API_KEY */] = 'The \"apiKey\" field is empty in the local Firebase config. Firebase Analytics requires this field to' +\r\n        'contain a valid API key.',\r\n    _a[\"no-app-id\" /* NO_APP_ID */] = 'The \"appId\" field is empty in the local Firebase config. Firebase Analytics requires this field to' +\r\n        'contain a valid app ID.',\r\n    _a);\r\nvar ERROR_FACTORY = new ErrorFactory('analytics', 'Analytics', ERRORS);\n\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/**\r\n * Backoff factor for 503 errors, which we want to be conservative about\r\n * to avoid overloading servers. Each retry interval will be\r\n * BASE_INTERVAL_MILLIS * LONG_RETRY_FACTOR ^ retryCount, so the second one\r\n * will be ~30 seconds (with fuzzing).\r\n */\r\nvar LONG_RETRY_FACTOR = 30;\r\n/**\r\n * Base wait interval to multiplied by backoffFactor^backoffCount.\r\n */\r\nvar BASE_INTERVAL_MILLIS = 1000;\r\n/**\r\n * Stubbable retry data storage class.\r\n */\r\nvar RetryData = /** @class */ (function () {\r\n    function RetryData(throttleMetadata, intervalMillis) {\r\n        if (throttleMetadata === void 0) { throttleMetadata = {}; }\r\n        if (intervalMillis === void 0) { intervalMillis = BASE_INTERVAL_MILLIS; }\r\n        this.throttleMetadata = throttleMetadata;\r\n        this.intervalMillis = intervalMillis;\r\n    }\r\n    RetryData.prototype.getThrottleMetadata = function (appId) {\r\n        return this.throttleMetadata[appId];\r\n    };\r\n    RetryData.prototype.setThrottleMetadata = function (appId, metadata) {\r\n        this.throttleMetadata[appId] = metadata;\r\n    };\r\n    RetryData.prototype.deleteThrottleMetadata = function (appId) {\r\n        delete this.throttleMetadata[appId];\r\n    };\r\n    return RetryData;\r\n}());\r\nvar defaultRetryData = new RetryData();\r\n/**\r\n * Set GET request headers.\r\n * @param apiKey App API key.\r\n */\r\nfunction getHeaders(apiKey) {\r\n    return new Headers({\r\n        Accept: 'application/json',\r\n        'x-goog-api-key': apiKey\r\n    });\r\n}\r\n/**\r\n * Fetches dynamic config from backend.\r\n * @param app Firebase app to fetch config for.\r\n */\r\nfunction fetchDynamicConfig(appFields) {\r\n    var _a;\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var appId, apiKey, request, appUrl, response, errorMessage, jsonResponse;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    appId = appFields.appId, apiKey = appFields.apiKey;\r\n                    request = {\r\n                        method: 'GET',\r\n                        headers: getHeaders(apiKey)\r\n                    };\r\n                    appUrl = DYNAMIC_CONFIG_URL.replace('{app-id}', appId);\r\n                    return [4 /*yield*/, fetch(appUrl, request)];\r\n                case 1:\r\n                    response = _b.sent();\r\n                    if (!(response.status !== 200 && response.status !== 304)) return [3 /*break*/, 6];\r\n                    errorMessage = '';\r\n                    _b.label = 2;\r\n                case 2:\r\n                    _b.trys.push([2, 4, , 5]);\r\n                    return [4 /*yield*/, response.json()];\r\n                case 3:\r\n                    jsonResponse = (_b.sent());\r\n                    if ((_a = jsonResponse.error) === null || _a === void 0 ? void 0 : _a.message) {\r\n                        errorMessage = jsonResponse.error.message;\r\n                    }\r\n                    return [3 /*break*/, 5];\r\n                case 4:\r\n                    _b.sent();\r\n                    return [3 /*break*/, 5];\r\n                case 5: throw ERROR_FACTORY.create(\"config-fetch-failed\" /* CONFIG_FETCH_FAILED */, {\r\n                    httpStatus: response.status,\r\n                    responseMessage: errorMessage\r\n                });\r\n                case 6: return [2 /*return*/, response.json()];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Fetches dynamic config from backend, retrying if failed.\r\n * @param app Firebase app to fetch config for.\r\n */\r\nfunction fetchDynamicConfigWithRetry(app, \r\n// retryData and timeoutMillis are parameterized to allow passing a different value for testing.\r\nretryData, timeoutMillis) {\r\n    if (retryData === void 0) { retryData = defaultRetryData; }\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var _a, appId, apiKey, measurementId, throttleMetadata, signal;\r\n        var _this = this;\r\n        return __generator(this, function (_b) {\r\n            _a = app.options, appId = _a.appId, apiKey = _a.apiKey, measurementId = _a.measurementId;\r\n            if (!appId) {\r\n                throw ERROR_FACTORY.create(\"no-app-id\" /* NO_APP_ID */);\r\n            }\r\n            if (!apiKey) {\r\n                if (measurementId) {\r\n                    return [2 /*return*/, {\r\n                            measurementId: measurementId,\r\n                            appId: appId\r\n                        }];\r\n                }\r\n                throw ERROR_FACTORY.create(\"no-api-key\" /* NO_API_KEY */);\r\n            }\r\n            throttleMetadata = retryData.getThrottleMetadata(appId) || {\r\n                backoffCount: 0,\r\n                throttleEndTimeMillis: Date.now()\r\n            };\r\n            signal = new AnalyticsAbortSignal();\r\n            setTimeout(function () { return __awaiter(_this, void 0, void 0, function () {\r\n                return __generator(this, function (_a) {\r\n                    // Note a very low delay, eg < 10ms, can elapse before listeners are initialized.\r\n                    signal.abort();\r\n                    return [2 /*return*/];\r\n                });\r\n            }); }, timeoutMillis !== undefined ? timeoutMillis : FETCH_TIMEOUT_MILLIS);\r\n            return [2 /*return*/, attemptFetchDynamicConfigWithRetry({ appId: appId, apiKey: apiKey, measurementId: measurementId }, throttleMetadata, signal, retryData)];\r\n        });\r\n    });\r\n}\r\n/**\r\n * Runs one retry attempt.\r\n * @param appFields Necessary app config fields.\r\n * @param throttleMetadata Ongoing metadata to determine throttling times.\r\n * @param signal Abort signal.\r\n */\r\nfunction attemptFetchDynamicConfigWithRetry(appFields, _a, signal, retryData // for testing\r\n) {\r\n    var throttleEndTimeMillis = _a.throttleEndTimeMillis, backoffCount = _a.backoffCount;\r\n    if (retryData === void 0) { retryData = defaultRetryData; }\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var appId, measurementId, e_1, response, e_2, backoffMillis, throttleMetadata;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    appId = appFields.appId, measurementId = appFields.measurementId;\r\n                    _b.label = 1;\r\n                case 1:\r\n                    _b.trys.push([1, 3, , 4]);\r\n                    return [4 /*yield*/, setAbortableTimeout(signal, throttleEndTimeMillis)];\r\n                case 2:\r\n                    _b.sent();\r\n                    return [3 /*break*/, 4];\r\n                case 3:\r\n                    e_1 = _b.sent();\r\n                    if (measurementId) {\r\n                        logger.warn(\"Timed out fetching this Firebase app's measurement ID from the server.\" +\r\n                            (\" Falling back to the measurement ID \" + measurementId) +\r\n                            (\" provided in the \\\"measurementId\\\" field in the local Firebase config. [\" + e_1.message + \"]\"));\r\n                        return [2 /*return*/, { appId: appId, measurementId: measurementId }];\r\n                    }\r\n                    throw e_1;\r\n                case 4:\r\n                    _b.trys.push([4, 6, , 7]);\r\n                    return [4 /*yield*/, fetchDynamicConfig(appFields)];\r\n                case 5:\r\n                    response = _b.sent();\r\n                    // Note the SDK only clears throttle state if response is success or non-retriable.\r\n                    retryData.deleteThrottleMetadata(appId);\r\n                    return [2 /*return*/, response];\r\n                case 6:\r\n                    e_2 = _b.sent();\r\n                    if (!isRetriableError(e_2)) {\r\n                        retryData.deleteThrottleMetadata(appId);\r\n                        if (measurementId) {\r\n                            logger.warn(\"Failed to fetch this Firebase app's measurement ID from the server.\" +\r\n                                (\" Falling back to the measurement ID \" + measurementId) +\r\n                                (\" provided in the \\\"measurementId\\\" field in the local Firebase config. [\" + e_2.message + \"]\"));\r\n                            return [2 /*return*/, { appId: appId, measurementId: measurementId }];\r\n                        }\r\n                        else {\r\n                            throw e_2;\r\n                        }\r\n                    }\r\n                    backoffMillis = Number(e_2.customData.httpStatus) === 503\r\n                        ? calculateBackoffMillis(backoffCount, retryData.intervalMillis, LONG_RETRY_FACTOR)\r\n                        : calculateBackoffMillis(backoffCount, retryData.intervalMillis);\r\n                    throttleMetadata = {\r\n                        throttleEndTimeMillis: Date.now() + backoffMillis,\r\n                        backoffCount: backoffCount + 1\r\n                    };\r\n                    // Persists state.\r\n                    retryData.setThrottleMetadata(appId, throttleMetadata);\r\n                    logger.debug(\"Calling attemptFetch again in \" + backoffMillis + \" millis\");\r\n                    return [2 /*return*/, attemptFetchDynamicConfigWithRetry(appFields, throttleMetadata, signal, retryData)];\r\n                case 7: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Supports waiting on a backoff by:\r\n *\r\n * <ul>\r\n *   <li>Promisifying setTimeout, so we can set a timeout in our Promise chain</li>\r\n *   <li>Listening on a signal bus for abort events, just like the Fetch API</li>\r\n *   <li>Failing in the same way the Fetch API fails, so timing out a live request and a throttled\r\n *       request appear the same.</li>\r\n * </ul>\r\n *\r\n * <p>Visible for testing.\r\n */\r\nfunction setAbortableTimeout(signal, throttleEndTimeMillis) {\r\n    return new Promise(function (resolve, reject) {\r\n        // Derives backoff from given end time, normalizing negative numbers to zero.\r\n        var backoffMillis = Math.max(throttleEndTimeMillis - Date.now(), 0);\r\n        var timeout = setTimeout(resolve, backoffMillis);\r\n        // Adds listener, rather than sets onabort, because signal is a shared object.\r\n        signal.addEventListener(function () {\r\n            clearTimeout(timeout);\r\n            // If the request completes before this timeout, the rejection has no effect.\r\n            reject(ERROR_FACTORY.create(\"fetch-throttle\" /* FETCH_THROTTLE */, {\r\n                throttleEndTimeMillis: throttleEndTimeMillis\r\n            }));\r\n        });\r\n    });\r\n}\r\n/**\r\n * Returns true if the {@link Error} indicates a fetch request may succeed later.\r\n */\r\nfunction isRetriableError(e) {\r\n    if (!(e instanceof FirebaseError) || !e.customData) {\r\n        return false;\r\n    }\r\n    // Uses string index defined by ErrorData, which FirebaseError implements.\r\n    var httpStatus = Number(e.customData['httpStatus']);\r\n    return (httpStatus === 429 ||\r\n        httpStatus === 500 ||\r\n        httpStatus === 503 ||\r\n        httpStatus === 504);\r\n}\r\n/**\r\n * Shims a minimal AbortSignal (copied from Remote Config).\r\n *\r\n * <p>AbortController's AbortSignal conveniently decouples fetch timeout logic from other aspects\r\n * of networking, such as retries. Firebase doesn't use AbortController enough to justify a\r\n * polyfill recommendation, like we do with the Fetch API, but this minimal shim can easily be\r\n * swapped out if/when we do.\r\n */\r\nvar AnalyticsAbortSignal = /** @class */ (function () {\r\n    function AnalyticsAbortSignal() {\r\n        this.listeners = [];\r\n    }\r\n    AnalyticsAbortSignal.prototype.addEventListener = function (listener) {\r\n        this.listeners.push(listener);\r\n    };\r\n    AnalyticsAbortSignal.prototype.abort = function () {\r\n        this.listeners.forEach(function (listener) { return listener(); });\r\n    };\r\n    return AnalyticsAbortSignal;\r\n}());\n\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction validateIndexedDB() {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var e_1;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (!!isIndexedDBAvailable()) return [3 /*break*/, 1];\r\n                    logger.warn(ERROR_FACTORY.create(\"indexeddb-unavailable\" /* INDEXEDDB_UNAVAILABLE */, {\r\n                        errorInfo: 'IndexedDB is not available in this environment.'\r\n                    }).message);\r\n                    return [2 /*return*/, false];\r\n                case 1:\r\n                    _a.trys.push([1, 3, , 4]);\r\n                    return [4 /*yield*/, validateIndexedDBOpenable()];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [3 /*break*/, 4];\r\n                case 3:\r\n                    e_1 = _a.sent();\r\n                    logger.warn(ERROR_FACTORY.create(\"indexeddb-unavailable\" /* INDEXEDDB_UNAVAILABLE */, {\r\n                        errorInfo: e_1\r\n                    }).message);\r\n                    return [2 /*return*/, false];\r\n                case 4: return [2 /*return*/, true];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Initialize the analytics instance in gtag.js by calling config command with fid.\r\n *\r\n * NOTE: We combine analytics initialization and setting fid together because we want fid to be\r\n * part of the `page_view` event that's sent during the initialization\r\n * @param app Firebase app\r\n * @param gtagCore The gtag function that's not wrapped.\r\n * @param dynamicConfigPromisesList Array of all dynamic config promises.\r\n * @param measurementIdToAppId Maps measurementID to appID.\r\n * @param installations FirebaseInstallations instance.\r\n *\r\n * @returns Measurement ID.\r\n */\r\nfunction initializeIds(app, dynamicConfigPromisesList, measurementIdToAppId, installations, gtagCore, dataLayerName) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var dynamicConfigPromise, fidPromise, _a, dynamicConfig, fid, configProperties;\r\n        var _b;\r\n        return __generator(this, function (_c) {\r\n            switch (_c.label) {\r\n                case 0:\r\n                    dynamicConfigPromise = fetchDynamicConfigWithRetry(app);\r\n                    // Once fetched, map measurementIds to appId, for ease of lookup in wrapped gtag function.\r\n                    dynamicConfigPromise\r\n                        .then(function (config) {\r\n                        measurementIdToAppId[config.measurementId] = config.appId;\r\n                        if (app.options.measurementId &&\r\n                            config.measurementId !== app.options.measurementId) {\r\n                            logger.warn(\"The measurement ID in the local Firebase config (\" + app.options.measurementId + \")\" +\r\n                                (\" does not match the measurement ID fetched from the server (\" + config.measurementId + \").\") +\r\n                                \" To ensure analytics events are always sent to the correct Analytics property,\" +\r\n                                \" update the\" +\r\n                                \" measurement ID field in the local config or remove it from the local config.\");\r\n                        }\r\n                    })\r\n                        .catch(function (e) { return logger.error(e); });\r\n                    // Add to list to track state of all dynamic config promises.\r\n                    dynamicConfigPromisesList.push(dynamicConfigPromise);\r\n                    fidPromise = validateIndexedDB().then(function (envIsValid) {\r\n                        if (envIsValid) {\r\n                            return installations.getId();\r\n                        }\r\n                        else {\r\n                            return undefined;\r\n                        }\r\n                    });\r\n                    return [4 /*yield*/, Promise.all([\r\n                            dynamicConfigPromise,\r\n                            fidPromise\r\n                        ])];\r\n                case 1:\r\n                    _a = _c.sent(), dynamicConfig = _a[0], fid = _a[1];\r\n                    // Detect if user has already put the gtag <script> tag on this page.\r\n                    if (!findGtagScriptOnPage()) {\r\n                        insertScriptTag(dataLayerName, dynamicConfig.measurementId);\r\n                    }\r\n                    // This command initializes gtag.js and only needs to be called once for the entire web app,\r\n                    // but since it is idempotent, we can call it multiple times.\r\n                    // We keep it together with other initialization logic for better code structure.\r\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                    gtagCore('js', new Date());\r\n                    configProperties = (_b = {},\r\n                        // guard against developers accidentally setting properties with prefix `firebase_`\r\n                        _b[ORIGIN_KEY] = 'firebase',\r\n                        _b.update = true,\r\n                        _b);\r\n                    if (fid != null) {\r\n                        configProperties[GA_FID_KEY] = fid;\r\n                    }\r\n                    // It should be the first config command called on this GA-ID\r\n                    // Initialize this GA-ID and set FID on it using the gtag config API.\r\n                    // Note: This will trigger a page_view event unless 'send_page_view' is set to false in\r\n                    // `configProperties`.\r\n                    gtagCore(GtagCommand.CONFIG, dynamicConfig.measurementId, configProperties);\r\n                    return [2 /*return*/, dynamicConfig.measurementId];\r\n            }\r\n        });\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/**\r\n * Maps appId to full initialization promise. Wrapped gtag calls must wait on\r\n * all or some of these, depending on the call's `send_to` param and the status\r\n * of the dynamic config fetches (see below).\r\n */\r\nvar initializationPromisesMap = {};\r\n/**\r\n * List of dynamic config fetch promises. In certain cases, wrapped gtag calls\r\n * wait on all these to be complete in order to determine if it can selectively\r\n * wait for only certain initialization (FID) promises or if it must wait for all.\r\n */\r\nvar dynamicConfigPromisesList = [];\r\n/**\r\n * Maps fetched measurementIds to appId. Populated when the app's dynamic config\r\n * fetch completes. If already populated, gtag config calls can use this to\r\n * selectively wait for only this app's initialization promise (FID) instead of all\r\n * initialization promises.\r\n */\r\nvar measurementIdToAppId = {};\r\n/**\r\n * Name for window global data layer array used by GA: defaults to 'dataLayer'.\r\n */\r\nvar dataLayerName = 'dataLayer';\r\n/**\r\n * Name for window global gtag function used by GA: defaults to 'gtag'.\r\n */\r\nvar gtagName = 'gtag';\r\n/**\r\n * Reproduction of standard gtag function or reference to existing\r\n * gtag function on window object.\r\n */\r\nvar gtagCoreFunction;\r\n/**\r\n * Wrapper around gtag function that ensures FID is sent with all\r\n * relevant event and config calls.\r\n */\r\nvar wrappedGtagFunction;\r\n/**\r\n * Flag to ensure page initialization steps (creation or wrapping of\r\n * dataLayer and gtag script) are only run once per page load.\r\n */\r\nvar globalInitDone = false;\r\n/**\r\n * For testing\r\n */\r\nfunction resetGlobalVars(newGlobalInitDone, newInitializationPromisesMap, newDynamicPromises) {\r\n    if (newGlobalInitDone === void 0) { newGlobalInitDone = false; }\r\n    if (newInitializationPromisesMap === void 0) { newInitializationPromisesMap = {}; }\r\n    if (newDynamicPromises === void 0) { newDynamicPromises = []; }\r\n    globalInitDone = newGlobalInitDone;\r\n    initializationPromisesMap = newInitializationPromisesMap;\r\n    dynamicConfigPromisesList = newDynamicPromises;\r\n    dataLayerName = 'dataLayer';\r\n    gtagName = 'gtag';\r\n}\r\n/**\r\n * For testing\r\n */\r\nfunction getGlobalVars() {\r\n    return {\r\n        initializationPromisesMap: initializationPromisesMap,\r\n        dynamicConfigPromisesList: dynamicConfigPromisesList\r\n    };\r\n}\r\n/**\r\n * This must be run before calling firebase.analytics() or it won't\r\n * have any effect.\r\n * @param options Custom gtag and dataLayer names.\r\n */\r\nfunction settings(options) {\r\n    if (globalInitDone) {\r\n        throw ERROR_FACTORY.create(\"already-initialized\" /* ALREADY_INITIALIZED */);\r\n    }\r\n    if (options.dataLayerName) {\r\n        dataLayerName = options.dataLayerName;\r\n    }\r\n    if (options.gtagName) {\r\n        gtagName = options.gtagName;\r\n    }\r\n}\r\n/**\r\n * Returns true if no environment mismatch is found.\r\n * If environment mismatches are found, throws an INVALID_ANALYTICS_CONTEXT\r\n * error that also lists details for each mismatch found.\r\n */\r\nfunction warnOnBrowserContextMismatch() {\r\n    var mismatchedEnvMessages = [];\r\n    if (isBrowserExtension()) {\r\n        mismatchedEnvMessages.push('This is a browser extension environment.');\r\n    }\r\n    if (!areCookiesEnabled()) {\r\n        mismatchedEnvMessages.push('Cookies are not available.');\r\n    }\r\n    if (mismatchedEnvMessages.length > 0) {\r\n        var details = mismatchedEnvMessages\r\n            .map(function (message, index) { return \"(\" + (index + 1) + \") \" + message; })\r\n            .join(' ');\r\n        var err = ERROR_FACTORY.create(\"invalid-analytics-context\" /* INVALID_ANALYTICS_CONTEXT */, {\r\n            errorInfo: details\r\n        });\r\n        logger.warn(err.message);\r\n    }\r\n}\r\nfunction factory(app, installations) {\r\n    warnOnBrowserContextMismatch();\r\n    var appId = app.options.appId;\r\n    if (!appId) {\r\n        throw ERROR_FACTORY.create(\"no-app-id\" /* NO_APP_ID */);\r\n    }\r\n    if (!app.options.apiKey) {\r\n        if (app.options.measurementId) {\r\n            logger.warn(\"The \\\"apiKey\\\" field is empty in the local Firebase config. This is needed to fetch the latest\" +\r\n                (\" measurement ID for this Firebase app. Falling back to the measurement ID \" + app.options.measurementId) +\r\n                \" provided in the \\\"measurementId\\\" field in the local Firebase config.\");\r\n        }\r\n        else {\r\n            throw ERROR_FACTORY.create(\"no-api-key\" /* NO_API_KEY */);\r\n        }\r\n    }\r\n    if (initializationPromisesMap[appId] != null) {\r\n        throw ERROR_FACTORY.create(\"already-exists\" /* ALREADY_EXISTS */, {\r\n            id: appId\r\n        });\r\n    }\r\n    if (!globalInitDone) {\r\n        // Steps here should only be done once per page: creation or wrapping\r\n        // of dataLayer and global gtag function.\r\n        getOrCreateDataLayer(dataLayerName);\r\n        var _a = wrapOrCreateGtag(initializationPromisesMap, dynamicConfigPromisesList, measurementIdToAppId, dataLayerName, gtagName), wrappedGtag = _a.wrappedGtag, gtagCore = _a.gtagCore;\r\n        wrappedGtagFunction = wrappedGtag;\r\n        gtagCoreFunction = gtagCore;\r\n        globalInitDone = true;\r\n    }\r\n    // Async but non-blocking.\r\n    // This map reflects the completion state of all promises for each appId.\r\n    initializationPromisesMap[appId] = initializeIds(app, dynamicConfigPromisesList, measurementIdToAppId, installations, gtagCoreFunction, dataLayerName);\r\n    var analyticsInstance = {\r\n        app: app,\r\n        // Public methods return void for API simplicity and to better match gtag,\r\n        // while internal implementations return promises.\r\n        logEvent: function (eventName, eventParams, options) {\r\n            logEvent(wrappedGtagFunction, initializationPromisesMap[appId], eventName, eventParams, options).catch(function (e) { return logger.error(e); });\r\n        },\r\n        setCurrentScreen: function (screenName, options) {\r\n            setCurrentScreen(wrappedGtagFunction, initializationPromisesMap[appId], screenName, options).catch(function (e) { return logger.error(e); });\r\n        },\r\n        setUserId: function (id, options) {\r\n            setUserId(wrappedGtagFunction, initializationPromisesMap[appId], id, options).catch(function (e) { return logger.error(e); });\r\n        },\r\n        setUserProperties: function (properties, options) {\r\n            setUserProperties(wrappedGtagFunction, initializationPromisesMap[appId], properties, options).catch(function (e) { return logger.error(e); });\r\n        },\r\n        setAnalyticsCollectionEnabled: function (enabled) {\r\n            setAnalyticsCollectionEnabled(initializationPromisesMap[appId], enabled).catch(function (e) { return logger.error(e); });\r\n        },\r\n        INTERNAL: {\r\n            delete: function () {\r\n                delete initializationPromisesMap[appId];\r\n                return Promise.resolve();\r\n            }\r\n        }\r\n    };\r\n    return analyticsInstance;\r\n}\n\nvar name = \"@firebase/analytics\";\nvar version = \"0.6.16\";\n\n/**\r\n * Type constant for Firebase Analytics.\r\n */\r\nvar ANALYTICS_TYPE = 'analytics';\r\nfunction registerAnalytics(instance) {\r\n    instance.INTERNAL.registerComponent(new Component(ANALYTICS_TYPE, function (container) {\r\n        // getImmediate for FirebaseApp will always succeed\r\n        var app = container.getProvider('app').getImmediate();\r\n        var installations = container\r\n            .getProvider('installations')\r\n            .getImmediate();\r\n        return factory(app, installations);\r\n    }, \"PUBLIC\" /* PUBLIC */).setServiceProps({\r\n        settings: settings,\r\n        EventName: EventName,\r\n        isSupported: isSupported\r\n    }));\r\n    instance.INTERNAL.registerComponent(new Component('analytics-internal', internalFactory, \"PRIVATE\" /* PRIVATE */));\r\n    instance.registerVersion(name, version);\r\n    function internalFactory(container) {\r\n        try {\r\n            var analytics = container.getProvider(ANALYTICS_TYPE).getImmediate();\r\n            return {\r\n                logEvent: analytics.logEvent\r\n            };\r\n        }\r\n        catch (e) {\r\n            throw ERROR_FACTORY.create(\"interop-component-reg-failed\" /* INTEROP_COMPONENT_REG_FAILED */, {\r\n                reason: e\r\n            });\r\n        }\r\n    }\r\n}\r\nregisterAnalytics(firebase);\r\n/**\r\n * this is a public static method provided to users that wraps four different checks:\r\n *\r\n * 1. check if it's not a browser extension environment.\r\n * 1. check if cookie is enabled in current browser.\r\n * 3. check if IndexedDB is supported by the browser environment.\r\n * 4. check if the current browser context is valid for using IndexedDB.\r\n *\r\n */\r\nfunction isSupported() {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var isDBOpenable;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (isBrowserExtension()) {\r\n                        return [2 /*return*/, false];\r\n                    }\r\n                    if (!areCookiesEnabled()) {\r\n                        return [2 /*return*/, false];\r\n                    }\r\n                    if (!isIndexedDBAvailable()) {\r\n                        return [2 /*return*/, false];\r\n                    }\r\n                    _a.label = 1;\r\n                case 1:\r\n                    _a.trys.push([1, 3, , 4]);\r\n                    return [4 /*yield*/, validateIndexedDBOpenable()];\r\n                case 2:\r\n                    isDBOpenable = _a.sent();\r\n                    return [2 /*return*/, isDBOpenable];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [2 /*return*/, false];\r\n                case 4: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\n\nexport { factory, getGlobalVars, registerAnalytics, resetGlobalVars, settings };\n//# sourceMappingURL=index.esm.js.map\n"]},"metadata":{},"sourceType":"module"}